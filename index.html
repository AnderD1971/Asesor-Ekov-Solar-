<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Ekov Solar - Asesor Solar Inteligente con Carrito de Compras">
    <title>Ekov Solar - Asesor Solar Inteligente</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FFB300">
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        :root {
            --primary: #FFB300;
            --primary-dark: #F57C00;
            --secondary: #1A237E;
            --secondary-light: #283593;
            --accent: #25D366;
            --accent-dark: #128C7E;
            --light: #F5F5F5;
            --dark: #212121;
            --gray: #757575;
            --white: #FFFFFF;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);
            --radius: 15px;
            --radius-sm: 8px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .app-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 500px;
            margin: 0 auto;
            width: 100%;
            background: var(--white);
            box-shadow: var(--shadow-lg);
            min-height: 100vh;
            position: relative;
        }
        
        .main-header {
            background: var(--secondary);
            color: var(--white);
            padding: 10px 20px;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--dark);
        }
        
        .logo-text {
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
        }
        
        .logo-subtitle {
            font-size: 0.75rem;
            opacity: 0.9;
            color: white;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .cart-icon {
            position: relative;
            cursor: pointer;
            font-size: 1.5rem;
            color: white;
        }
        
        .cart-count {
            position: absolute;
            top: -5px;
            right: -10px;
            background: var(--primary);
            color: var(--dark);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        .partner-badge {
            background: var(--primary);
            color: var(--dark);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: bold;
            display: none;
        }
        
        .direct-badge {
            background: var(--secondary-light);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: bold;
            display: none;
        }
        
        .social-header {
            display: flex;
            gap: 8px;
        }
        
        .social-header a {
            color: white;
            text-decoration: none;
            font-size: 1.2rem;
            transition: opacity 0.2s;
        }
        
        .social-header a:hover {
            opacity: 0.8;
        }
        
        .nav-tabs {
            display: flex;
            background: var(--light);
            border-bottom: 2px solid var(--primary);
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
        }
        
        .nav-tab {
            flex: 0 0 auto;
            padding: 12px 15px;
            text-align: center;
            background: none;
            border: none;
            font-weight: 600;
            color: var(--gray);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .nav-tab.active {
            color: var(--secondary);
            border-bottom: 3px solid var(--primary);
            background: linear-gradient(to bottom, rgba(255,179,0,0.1), transparent);
        }
        
        .main-content {
            flex: 1;
            padding: 0;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .step {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .step.active {
            display: block;
        }
        
        .card-sector {
            background: var(--white);
            border: 2px solid #ddd;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.2s ease;
        }
        
        .card-sector:hover {
            border-color: var(--primary);
            background: #fffcf0;
            transform: translateY(-2px);
        }
        
        .device-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .device-row label {
            font-weight: 500;
            color: var(--dark);
        }
        
        .device-row select, .device-row input {
            width: 140px;
            padding: 8px;
            border-radius: var(--radius-sm);
            border: 1px solid #ddd;
            font-size: 14px;
        }
        
        .hero {
            padding: 30px 20px;
            background: linear-gradient(135deg, #fff8e1 0%, #e3f2fd 100%);
            text-align: center;
            position: relative;
        }
        
        /* Estilos para enlaces de video */
        .video-tutorial-link {
            display: inline-block;
            margin: 10px auto 0;
            padding: 8px 20px;
            background: white;
            border-radius: 50px;
            border: 1px solid #ff0000;
            color: #333;
            text-decoration: none;
            font-size: 0.9rem;
            transition: background 0.2s, transform 0.2s;
        }
        
        .video-tutorial-link:hover {
            background: #fff0f0;
            transform: translateY(-2px);
        }
        
        .video-tutorial-link i {
            color: #ff0000;
            margin-right: 5px;
        }
        
        /* ===== CONTENEDORES DE IMAGEN CON PADDING-BOTTOM ===== */
        /* Para productos (relaci√≥n 3:2) */
        .product-image {
            position: relative;
            width: 100%;
            padding-bottom: 66.67%;
            background-color: #f5f5f5;
            overflow: hidden;
        }
        
        .product-image img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        
        /* Para miniaturas de YouTube (16:9) */
        .tutorial-thumbnail {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%;
            background-color: #f0f0f0;
            overflow: hidden;
        }
        
        .tutorial-thumbnail img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Para cat√°logo WhatsApp (2:1, 300x150) */
        .catalog-image {
            position: relative;
            width: 100%;
            padding-bottom: 50%;
            background-color: #f5f5f5;
            overflow: hidden;
        }
        
        .catalog-image img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Para im√°genes del carrito (60x60) */
        .cart-item-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            background-color: #f5f5f5;
            flex-shrink: 0;
        }
        
        .tutorial-grid {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }
        
        .tutorial-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: var(--radius);
            overflow: hidden;
            transition: transform 0.2s;
        }
        
        .tutorial-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }
        
        .tutorial-info {
            padding: 15px;
        }
        
        .tutorial-info h4 {
            margin-bottom: 5px;
            color: var(--dark);
        }
        
        .tutorial-info p {
            color: var(--gray);
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        
        .tutorial-link {
            color: var(--secondary);
            text-decoration: none;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .tutorial-link:hover {
            text-decoration: underline;
        }
        
        .product-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            padding: 20px;
        }
        
        .product-card {
            background: var(--white);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        
        .product-info {
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .product-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--dark);
        }
        
        .product-description {
            color: var(--gray);
            margin-bottom: 15px;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .product-price {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 15px;
        }
        
        .btn-main {
            background: var(--primary);
            color: var(--dark);
            border: none;
            padding: 12px;
            width: 100%;
            border-radius: var(--radius-sm);
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            text-transform: uppercase;
            transition: background 0.3s ease;
        }
        
        .btn-main:hover {
            background: var(--primary-dark);
        }
        
        .whatsapp-button {
            background-color: var(--accent);
            color: var(--white);
            border: none;
            padding: 12px;
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background 0.3s ease;
            width: 100%;
            text-decoration: none;
            text-align: center;
            font-size: 14px;
        }
        
        .whatsapp-button:hover {
            background-color: var(--accent-dark);
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--secondary);
            color: var(--secondary);
            padding: 10px;
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .btn-outline:hover {
            background: var(--secondary);
            color: white;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        /* Botones de redes sociales en footer */
        .social-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
        }
        
        .social-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--secondary);
            color: white;
            text-decoration: none;
            transition: transform 0.2s, background 0.2s;
            font-size: 1.2rem;
        }
        
        .social-button:hover {
            transform: translateY(-3px);
        }
        
        .social-button.facebook:hover {
            background: #1877f2;
        }
        .social-button.instagram:hover {
            background: #e4405f;
        }
        .social-button.youtube:hover {
            background: #ff0000;
        }
        
        /* Secci√≥n de asesor√≠a */
        .contact-info {
            background: #f9f9f9;
            padding: 20px;
            border-radius: var(--radius);
            border: 2px solid var(--primary);
            text-align: center;
        }
        
        .contact-info h3 {
            color: var(--secondary);
            margin-bottom: 20px;
        }
        
        .contact-item {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 1rem;
        }
        
        .contact-item i {
            font-size: 1.5rem;
            color: var(--secondary);
        }
        
        .contact-item a {
            color: var(--secondary);
            text-decoration: none;
            font-weight: 500;
        }
        
        .contact-item a:hover {
            text-decoration: underline;
        }
        
        .contact-social {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        
        .contact-social a {
            color: var(--secondary);
            font-size: 2rem;
            transition: color 0.2s;
        }
        
        .contact-social a:hover {
            color: var(--primary);
        }
        
        .result-box {
            text-align: center;
            padding: 25px;
            background: #f9f9f9;
            border: 2px solid var(--primary);
            border-radius: var(--radius);
            margin-bottom: 20px;
        }
        
        /* Ocultar la l√≠nea de datos t√©cnicos */
        #cons-info {
            display: none;
        }
        
        .tech-data {
            font-size: 0.9em;
            color: var(--gray);
            margin-bottom: 15px;
            padding: 10px;
            background: var(--white);
            border-radius: var(--radius-sm);
        }
        
        .partner-info-box {
            background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%);
            border: 2px dashed #4CAF50;
            border-radius: var(--radius);
            padding: 15px;
            margin: 20px 0;
            text-align: center;
            display: none;
        }
        
        .direct-info-box {
            background: linear-gradient(135deg, #e3f2fd 0%, #f1f8ff 100%);
            border: 2px dashed var(--secondary);
            border-radius: var(--radius);
            padding: 15px;
            margin: 20px 0;
            text-align: center;
            display: none;
        }
        
        .link-saver-card {
            background: white;
            border: 2px solid var(--primary);
            border-radius: var(--radius);
            padding: 20px;
            margin: 20px 0;
            box-shadow: var(--shadow-lg);
            position: relative;
            animation: slideIn 0.4s ease;
            display: none;
        }
        
        .link-saver-card h4 {
            color: var(--secondary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .link-saver-card p {
            color: var(--gray);
            margin-bottom: 15px;
            font-size: 0.95rem;
        }
        
        .link-box {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--light);
            padding: 10px 15px;
            border-radius: var(--radius-sm);
            margin-bottom: 15px;
        }
        
        .link-box input {
            flex: 1;
            background: transparent;
            border: none;
            padding: 8px 0;
            font-size: 0.85rem;
            color: var(--dark);
            outline: none;
        }
        
        .link-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .close-link-saver {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--gray);
        }
        
        .cart-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            gap: 10px;
        }
        
        .cart-item-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .cart-item-details {
            flex: 1;
        }
        
        .cart-item-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .cart-item-price {
            color: var(--primary);
            font-weight: 700;
        }
        
        .cart-item-quantity {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 5px;
        }
        
        .cart-item-quantity button {
            background: var(--light);
            border: 1px solid #ddd;
            width: 30px;
            height: 30px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .cart-total {
            padding: 20px;
            font-size: 1.2rem;
            font-weight: 700;
            text-align: right;
            border-top: 2px solid var(--primary);
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 20px;
            max-width: 400px;
            width: 100%;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.4s ease;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-content h3 {
            color: var(--secondary);
            margin-bottom: 15px;
            font-size: 1.5rem;
            text-align: center;
        }
        
        .modal-content h4 {
            color: var(--secondary);
            margin-bottom: 10px;
        }
        
        .modal-content .bank-details {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: left;
            font-size: 0.9rem;
        }
        
        .modal-content .input-group {
            margin-bottom: 15px;
        }
        
        .modal-content .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .modal-content .input-group input[type="text"],
        .modal-content .input-group input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .modal-content .input-group input[type="checkbox"] {
            margin-right: 8px;
        }
        
        .modal-footer {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .store-link {
            display: inline-block;
            margin-top: 10px;
            color: var(--secondary);
            text-decoration: underline;
            font-weight: 500;
            cursor: pointer;
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--gray);
        }
        
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .main-footer {
            background: var(--dark);
            color: var(--white);
            padding: 25px 20px;
            text-align: center;
            margin-top: auto;
        }
        
        .footer-info {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
            display: none;
        }
        
        @media (min-width: 768px) {
            .app-container {
                max-width: 800px;
                margin: 20px auto;
                border-radius: var(--radius);
                overflow: hidden;
            }
            .product-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (min-width: 1024px) {
            .app-container {
                max-width: 1000px;
            }
            .product-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- HEADER -->
        <header class="main-header">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">‚òÄÔ∏è</div>
                    <div>
                        <div class="logo-text">EKOV SOLAR</div>
                        <div class="logo-subtitle">Asesor Solar Inteligente</div>
                    </div>
                </div>
                <div class="header-right">
                    <div class="partner-badge" id="partnerBadge"></div>
                    <div class="direct-badge" id="directBadge">üì± Visita Directa</div>
                    <div class="cart-icon" onclick="switchTab('cart')">
                        üõí
                        <span class="cart-count" id="cartCount">0</span>
                    </div>
                    <div class="social-header">
                        <a href="https://facebook.com/tupagina" target="_blank" title="Facebook"><i class="fab fa-facebook-f"></i></a>
                        <a href="https://instagram.com/tupagina" target="_blank" title="Instagram"><i class="fab fa-instagram"></i></a>
                        <a href="https://youtube.com/tupagina" target="_blank" title="YouTube"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- NAVEGACI√ìN -->
        <nav class="nav-tabs">
            <button class="nav-tab active" data-tab="calculator">üìä Calculadora</button>
            <button class="nav-tab" data-tab="store">üè™ Tienda</button>
            <button class="nav-tab" data-tab="catalog">üìã Cat√°logo</button>
            <button class="nav-tab" data-tab="asesoria">üìû Asesor√≠a</button>
            <button class="nav-tab" data-tab="tutorials">üìö Tutoriales</button>
            <button class="nav-tab" data-tab="cart">üõí Carrito</button>
        </nav>
        
        <!-- CONTENIDO PRINCIPAL -->
        <main class="main-content">
            <!-- CALCULADORA -->
            <div id="calculator-tab" class="tab-content active">
                <div id="step1" class="step active">
                    <div class="hero">
                        <h1 style="color: var(--secondary); margin-bottom: 15px;">Asesor Solar Inteligente</h1>
                        <p style="color: var(--gray); margin-bottom: 25px;">Seleccione su √°rea de trabajo</p>
                        
                        <!-- Video de bienvenida en la p√°gina principal -->
                        <a href="https://youtu.be/placeholder_bienvenida" target="_blank" class="video-tutorial-link">
                            <i class="fab fa-youtube"></i> Ver video de bienvenida
                        </a>
                        
                        <!-- Video tutorial espec√≠fico de la calculadora -->
                        <a href="https://youtu.be/placeholder_calculadora" target="_blank" class="video-tutorial-link" style="margin-left: 10px;">
                            <i class="fab fa-youtube"></i> ¬øC√≥mo usar la calculadora?
                        </a>
                        
                        <div id="partnerInfo" class="partner-info-box">
                            <h4>ü§ù Visitando desde</h4>
                            <p id="partnerName" style="font-weight: bold; color: var(--secondary);"></p>
                            <p style="font-size: 0.9em; color: #666;" id="partnerLocation"></p>
                        </div>
                        
                        <div id="directInfo" class="direct-info-box">
                            <h4>üì± Visita Directa</h4>
                            <p style="font-weight: bold; color: var(--secondary);">Bienvenido a Ekov Solar</p>
                        </div>
                        
                        <!-- TARJETA DE GUARDAR ENLACE (CON OPCI√ìN COPIAR) -->
                        <div id="linkSaverCard" class="link-saver-card">
                            <button class="close-link-saver" onclick="closeLinkSaver()">‚úï</button>
                            <h4>üîó Guarda este enlace</h4>
                            <p>Guarda este enlace para acceder r√°pidamente en el futuro:</p>
                            <div class="link-box">
                                <input type="text" id="appLinkField" readonly value="">
                            </div>
                            <div class="link-actions">
                                <button class="btn-outline btn-small" onclick="copyAppLink()">üìã Copiar</button>
                                <button class="btn-outline btn-small" onclick="sendLinkToSelf()">üì≤ Enviarme</button>
                            </div>
                            <p style="font-size: 0.8rem; color: #666; margin-top: 15px;">
                                Tambi√©n recibir√°s este enlace por WhatsApp de nuestro aliado.
                            </p>
                        </div>
                    </div>
                    
                    <div style="padding: 20px;">
                        <div class="card-sector" onclick="initApp('hogar')">
                            <span style="font-size:30px; margin-right:15px">üè†</span>
                            <div><strong>Hogar / Apartamento</strong><br><small style="color: var(--gray);">Residencial</small></div>
                        </div>
                        <div class="card-sector" onclick="initApp('turismo')">
                            <span style="font-size:30px; margin-right:15px">üè®</span>
                            <div><strong>Hoteles y Posadas</strong><br><small style="color: var(--gray);">Turismo</small></div>
                        </div>
                        <div class="card-sector" onclick="initApp('comercio')">
                            <span style="font-size:30px; margin-right:15px">üè¢</span>
                            <div><strong>Comercio / Oficina</strong><br><small style="color: var(--gray);">Negocios</small></div>
                        </div>
                        <div class="card-sector" onclick="initApp('agro')">
                            <span style="font-size:30px; margin-right:15px">üöú</span>
                            <div><strong>Agro / Fincas</strong><br><small style="color: var(--gray);">Agricultura</small></div>
                        </div>
                        <div class="card-sector" onclick="initApp('telecom')">
                            <span style="font-size:30px; margin-right:15px">üì°</span>
                            <div><strong>Telecom / Seguridad</strong><br><small style="color: var(--gray);">Comunicaciones</small></div>
                        </div>
                        <div class="card-sector" onclick="initApp('bombas')">
                            <span style="font-size:30px; margin-right:15px">üö∞</span>
                            <div><strong>Bombas Solares</strong><br><small style="color: var(--gray);">Agua y riego</small></div>
                        </div>
                    </div>
                </div>
                
                <div id="step2" class="step">
                    <div style="padding: 20px;">
                        <h3 style="color: var(--secondary); margin-bottom: 20px;">Detalle de Carga</h3>
                        <div id="itemsContainer"></div>
                        <button class="btn-main" onclick="calculate()" style="margin-top:25px;">GENERAR RECOMENDACI√ìN</button>
                        <button onclick="showStep(1)" style="width:100%; background:none; border:none; margin-top:15px; color:var(--gray); cursor:pointer;">‚Üê Regresar</button>
                    </div>
                </div>
                
                <div id="step3" class="step">
                    <div style="padding: 20px;">
                        <div class="result-box">
                            <div class="tech-data" id="cons-info"></div>
                            <p style="margin:10px 0; font-weight:600;">SU SOLUCI√ìN IDEAL ES:</p>
                            <h2 id="kit-name" style="color:var(--secondary); margin:15px 0; font-size: 28px;"></h2>
                            <p id="kit-desc" style="font-size: 1em; color: #444;"></p>
                            <div id="storeLinkContainer" style="margin-top: 15px;"></div>
                        </div>
                        <div style="display: grid; gap: 10px; margin-top: 20px;">
                            <button class="nav-tab" onclick="switchTab('store')" style="background: var(--primary); color: var(--dark); border: none;">üõí VER TIENDA</button>
                            <button onclick="sendWA()" class="whatsapp-button">üí¨ Enviar Consulta</button>
                            <button onclick="resetCalculator()" style="width:100%; background:none; border:1px solid #ddd; padding:12px; color:var(--gray); border-radius:var(--radius-sm);">üîÑ Nueva Consulta</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- TIENDA -->
            <div id="store-tab" class="tab-content">
                <div class="hero">
                    <h1 style="color: var(--secondary); margin-bottom: 15px;">Tienda Ekov Solar</h1>
                    <p style="color: var(--gray);">Productos para todos los sectores</p>
                    
                    <!-- Video tutorial de la tienda -->
                    <a href="https://youtu.be/placeholder_tienda" target="_blank" class="video-tutorial-link">
                        <i class="fab fa-youtube"></i> Ver tutorial de la tienda
                    </a>
                    
                    <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button class="category-btn active" data-category="all">Todos</button>
                        <button class="category-btn" data-category="kits">Kits Solares</button>
                        <button class="category-btn" data-category="bombas-superficiales">Bombas Superficiales</button>
                        <button class="category-btn" data-category="bombas-sumergibles">Bombas Sumergibles</button>
                        <button class="category-btn" data-category="paneles">Paneles</button>
                    </div>
                </div>
                <div class="product-grid" id="productGrid">
                    <div class="loading" id="loadingState"><div class="loader"></div><p>Cargando productos...</p></div>
                </div>
            </div>
            
            <!-- CAT√ÅLOGO WHATSAPP -->
            <div id="catalog-tab" class="tab-content">
                <div class="hero">
                    <h2 style="color: var(--secondary); margin-bottom: 15px;">Cat√°logo WhatsApp Business</h2>
                    <p style="color: var(--gray); margin-bottom: 20px;">Productos disponibles</p>
                    
                    <!-- Video tutorial del cat√°logo -->
                    <a href="https://youtu.be/placeholder_catalogo" target="_blank" class="video-tutorial-link">
                        <i class="fab fa-youtube"></i> Ver tutorial del cat√°logo
                    </a>
                </div>
                <div id="whatsappCatalog" style="margin-top: 20px;"><div class="loading"><div class="loader"></div><p>Cargando...</p></div></div>
            </div>
            
            <!-- ASESOR√çA Y PROYECTOS -->
            <div id="asesoria-tab" class="tab-content">
                <div class="hero">
                    <h1 style="color: var(--secondary); margin-bottom: 15px;">üìû Asesor√≠a y Proyectos</h1>
                    <p style="color: var(--gray);">Soluciones t√©cnicas personalizadas para su proyecto solar</p>
                    
                    <!-- Video tutorial de asesor√≠a -->
                    <a href="https://youtu.be/placeholder_asesoria" target="_blank" class="video-tutorial-link">
                        <i class="fab fa-youtube"></i> Ver video de asesor√≠a
                    </a>
                </div>
                <div class="contact-info">
                    <h3>Informaci√≥n de contacto</h3>
                    
                    <div class="contact-item">
                        <i class="fas fa-envelope"></i>
                        <a href="mailto:info@ekovsolar.com.ve">info@ekovsolar.com.ve</a>
                    </div>
                    
                    <div class="contact-item">
                        <i class="fab fa-whatsapp"></i>
                        <a href="https://wa.me/584128399000">+58 412 839 9000 (Consultas)</a>
                    </div>
                    
                    <div class="contact-item">
                        <i class="fas fa-phone-alt"></i>
                        <a href="https://wa.me/584128399000">+58 412 839 9000 (Principal)</a>
                    </div>
                    
                    <div class="contact-social">
                        <a href="https://facebook.com/tupagina" target="_blank" title="Facebook"><i class="fab fa-facebook-f"></i></a>
                        <a href="https://instagram.com/tupagina" target="_blank" title="Instagram"><i class="fab fa-instagram"></i></a>
                        <a href="https://youtube.com/tupagina" target="_blank" title="YouTube"><i class="fab fa-youtube"></i></a>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #fff; border-radius: var(--radius-sm); text-align: left;">
                        <p style="margin-bottom: 10px; font-weight: 600;">Descripci√≥n del servicio:</p>
                        <p style="color: var(--dark); line-height: 1.6;">
                            Contamos con personal calificado para ofrecer asesor√≠a t√©cnica en proyectos solares de cualquier tama√±o. Realizamos evaluaciones, dise√±amos proyectos nuevos y optimizamos sistemas existentes. ¬øTiene un proyecto en mente? ¬°Cont√°ctenos para una asesor√≠a personalizada!
                        </p>
                    </div>
                    
                    <p style="margin-top: 20px; font-size: 0.9rem; color: var(--gray);">
                        Horario de atenci√≥n: Lunes a Viernes 8am - 5pm
                    </p>
                </div>
            </div>
            
            <!-- TUTORIALES -->
            <div id="tutorials-tab" class="tab-content">
                <div class="hero">
                    <h1 style="color: var(--secondary); margin-bottom: 15px;">üìö Tutoriales en video</h1>
                    <p style="color: var(--gray);">Aprende a usar nuestra aplicaci√≥n y descubre m√°s sobre energ√≠a solar</p>
                </div>
                
                <div class="tutorial-grid" id="tutorialGrid">
                    <!-- Se llenar√° con JavaScript -->
                </div>
            </div>
            
            <!-- CARRITO -->
            <div id="cart-tab" class="tab-content">
                <div style="padding: 20px;">
                    <h2 style="color: var(--secondary); margin-bottom: 20px;">üõí Tu Carrito</h2>
                    <div id="cartItems"></div>
                    <div id="cartEmpty" style="text-align: center; padding: 40px; color: var(--gray); display: none;">
                        <p>Tu carrito est√° vac√≠o</p>
                        <button class="btn-main" onclick="switchTab('store')">Ir a la tienda</button>
                    </div>
                    <div id="cartFooter" style="display: none;">
                        <div class="cart-total" id="cartTotal"></div>
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="btn-outline" onclick="clearCart()">Vaciar carrito</button>
                            <button class="whatsapp-button" onclick="checkoutCart()">Pagar ahora</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- FOOTER -->
        <footer class="main-footer">
            <div class="footer-content">
                <h3>EKOV SOLAR ¬© 2024</h3>
                <p style="margin: 10px 0;">Asesor Solar Inteligente</p>
                <p>üìû WhatsApp: +58 412 839 9000</p>
                <p>‚úâÔ∏è info@ekovsolar.com.ve</p>
                
                <!-- Redes sociales en footer -->
                <div class="social-buttons">
                    <a href="https://facebook.com/tupagina" target="_blank" class="social-button facebook" title="Facebook"><i class="fab fa-facebook-f"></i></a>
                    <a href="https://instagram.com/tupagina" target="_blank" class="social-button instagram" title="Instagram"><i class="fab fa-instagram"></i></a>
                    <a href="https://youtube.com/tupagina" target="_blank" class="social-button youtube" title="YouTube"><i class="fab fa-youtube"></i></a>
                </div>
                
                <div id="footerPartnerInfo" class="footer-info">
                    <p style="margin: 5px 0;">ü§ù <strong id="footerPartnerName">-</strong></p>
                    <p style="margin: 0; font-size:0.8rem;" id="footerPartnerLocation">-</p>
                </div>
                <div id="footerDirectInfo" class="footer-info">
                    <p style="margin: 5px 0;">üì± Visita Directa</p>
                </div>
            </div>
        </footer>
    </div>

    <!-- MODAL DE PAGO (CON BINANCE Y ZELLE) -->
    <div class="modal-overlay" id="paymentModal">
        <div class="modal-content">
            <h3>üí≥ Opciones de pago</h3>
            
            <!-- Paso 1: Selecci√≥n de m√©todo y datos -->
            <div id="step1-payment">
                <p>Seleccione el m√©todo de pago:</p>
                <div style="margin: 15px 0;">
                    <label style="display: block; margin-bottom: 10px;">
                        <input type="radio" name="metodoPago" value="transferencia" checked onchange="mostrarDatosPago()"> Transferencia bancaria
                    </label>
                    <label style="display: block; margin-bottom: 10px;">
                        <input type="radio" name="metodoPago" value="pagoMovil" onchange="mostrarDatosPago()"> Pago m√≥vil
                    </label>
                    <label style="display: block; margin-bottom: 10px;">
                        <input type="radio" name="metodoPago" value="binance" onchange="mostrarDatosPago()"> Binance (Cripto)
                    </label>
                    <label style="display: block; margin-bottom: 10px;">
                        <input type="radio" name="metodoPago" value="zelle" onchange="mostrarDatosPago()"> Zelle (USA)
                    </label>
                </div>
                
                <div id="datosTransferencia" class="bank-details">
                    <p><strong>Banco:</strong> Banco de Venezuela</p>
                    <p><strong>Titular:</strong> Ekov Solar C.A.</p>
                    <p><strong>RIF:</strong> J-12345678-9</p>
                    <p><strong>Cuenta Corriente:</strong> 0102-0123-45-12345678</p>
                </div>
                
                <div id="datosPagoMovil" class="bank-details" style="display: none;">
                    <p><strong>Banco:</strong> Banco de Venezuela</p>
                    <p><strong>Titular:</strong> Ekov Solar C.A.</p>
                    <p><strong>Tel√©fono:</strong> 0412-1234567</p>
                    <p><strong>C√©dula/RIF:</strong> J-12345678-9</p>
                </div>
                
                <div id="datosBinance" class="bank-details" style="display: none;">
                    <p><strong>Binance ID:</strong> 123456789</p>
                    <p><strong>Email Binance:</strong> pagos@ekovsolar.com</p>
                    <p><strong>Red:</strong> BEP20 (USDT) - Direcci√≥n: 0x1234...abcd</p>
                    <p><em>Enviar comprobante de la transacci√≥n.</em></p>
                </div>
                
                <div id="datosZelle" class="bank-details" style="display: none;">
                    <p><strong>Zelle (correo):</strong> pagos@ekovsolar.com</p>
                    <p><strong>Titular:</strong> Ekov Solar C.A.</p>
                    <p><strong>Tel√©fono (opcional):</strong> +58 412 1234567</p>
                    <p><em>Enviar comprobante por WhatsApp.</em></p>
                </div>
                
                <button class="btn-main" onclick="mostrarConfirmacionPago()">Continuar</button>
            </div>
            
            <!-- Paso 2: Confirmaci√≥n de pago -->
            <div id="step2-payment" style="display: none;">
                <h4>üìù Confirmar pago</h4>
                <div class="input-group">
                    <label>M√©todo elegido: <span id="metodoElegido"></span></label>
                </div>
                <div class="input-group">
                    <label>N√∫mero de referencia / ID de transacci√≥n</label>
                    <input type="text" id="paymentReference" placeholder="Ej: 123456789">
                </div>
                <div class="input-group">
                    <label>Monto pagado (Bs. o USD)</label>
                    <input type="number" id="paymentAmount" placeholder="Ej: 12500">
                </div>
                <div class="input-group">
                    <label>Tu nombre (opcional)</label>
                    <input type="text" id="paymentName" placeholder="Ej: Juan P√©rez">
                </div>
                <div class="input-group">
                    <label>
                        <input type="checkbox" id="confirmDelivery" checked> Acepto el tiempo de entrega estimado de <strong>3 a 5 d√≠as h√°biles</strong>.
                    </label>
                </div>
                <div class="modal-footer">
                    <button onclick="volverPaso1()" class="btn-outline">Volver</button>
                    <button onclick="sendPaymentConfirmation()" class="whatsapp-button">üì≤ Confirmar pago</button>
                </div>
            </div>
            
            <div class="modal-footer" id="modalCloseBtn">
                <button onclick="closePaymentModal()" class="btn-main" style="background: #dc3545;">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // ================== CONFIGURACI√ìN ==================
        const WHATSAPP_NUMBER = '584128399000'; // N√∫mero para consultas (sin 0 inicial)
        const CATALOG_WHATSAPP_NUMBER = '584140548833'; // N√∫mero con cat√°logo WhatsApp Business
        const COMPANY_NAME = 'Ekov Solar';
        const APP_URL = window.location.origin + window.location.pathname;
        
        // Placeholder local SVG (data URI) para im√°genes que no cargan (300x200)
        const PLACEHOLDER_SVG = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='200' viewBox='0 0 300 200'%3E%3Crect width='300' height='200' fill='%23f0f0f0'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dy='.3em' fill='%23999' font-size='14'%3Eüì∑ Imagen no disponible%3C/text%3E%3C/svg%3E";
        
        // ================== BASE DE DATOS DE ALIADOS ==================
        const PARTNERS_DATABASE = {
            'T001': { nombre: 'Ferreter√≠a El Sol', ubicacion: 'Caracas, Av. Principal', contacto: '+58 412 111 2233', activo: true },
            'T002': { nombre: 'Distribuidora Energ√©tica', ubicacion: 'Maracaibo, Centro Comercial', contacto: '+58 414 555 6677', activo: true },
            'T003': { nombre: 'Tecnolog√≠a Solar Plus', ubicacion: 'Valencia, Zona Industrial', contacto: '+58 416 888 9900', activo: true },
            'T004': { nombre: 'Tienda El√©ctrica San Mart√≠n', ubicacion: 'Barquisimeto, Centro', contacto: '+58 425 123 4567', activo: true },
            'T005': { nombre: 'Energ√≠a Renovable C.A.', ubicacion: 'M√©rida, Av. Las Am√©ricas', contacto: '+58 427 987 6543', activo: true }
        };

        // ================== PRODUCTOS DE LA TIENDA ==================
        const storeProducts = [
            // Kits solares
            { 
                id: 'ekov1000', 
                name: 'EKOV RESCUE 1000', 
                category: 'kits', 
                price: 12500, 
                description: 'Kit solar b√°sico para iluminaci√≥n y dispositivos esenciales. Ideal para respaldo en hogares.',
                image: 'https://via.placeholder.com/300x200?text=Kit+Rescue+1000', // Reemplazar con imagen real
                specs: ['Potencia: 1000W', 'Bater√≠a: 100Ah', 'Panel: 2x250W', 'Inversor: 1000W'],
                whatsappId: 'EKOV1000' 
            },
            { 
                id: 'ekov3000', 
                name: 'EKOV COMFORT 3000', 
                category: 'kits', 
                price: 28900, 
                description: 'Kit solar para confort en hogares, incluye nevera, iluminaci√≥n y TV.',
                image: 'https://via.placeholder.com/300x200?text=Kit+Comfort+3000',
                specs: ['Potencia: 3000W', 'Bater√≠a: 200Ah', 'Panel: 4x300W', 'Inversor: 3000W'],
                whatsappId: 'EKOV3000' 
            },
            { 
                id: 'ekov5000', 
                name: 'EKOV INDEPENDENCE 5000', 
                category: 'kits', 
                price: 45200, 
                description: 'Kit solar para peque√±as empresas, soporta equipos de oficina y climatizaci√≥n.',
                image: 'https://via.placeholder.com/300x200?text=Kit+Independence+5000',
                specs: ['Potencia: 5000W', 'Bater√≠a: 400Ah', 'Panel: 8x350W', 'Inversor: 5000W'],
                whatsappId: 'EKOV5000' 
            },
            { 
                id: 'ekov12000', 
                name: 'EKOV INDUSTRIAL 12000', 
                category: 'kits', 
                price: 105000, 
                description: 'Kit solar industrial para grandes consumos, ideal para hoteles y f√°bricas.',
                image: 'https://via.placeholder.com/300x200?text=Kit+Industrial+12000',
                specs: ['Potencia: 12000W', 'Bater√≠a: 800Ah', 'Panel: 20x350W', 'Inversor: 12000W'],
                whatsappId: 'EKOV12000' 
            },
            { 
                id: 'ekov15000', 
                name: 'EKOV INDUSTRIAL 15000', 
                category: 'kits', 
                price: 132000, 
                description: 'Kit solar de alta potencia para proyectos grandes y sistemas trif√°sicos.',
                image: 'https://via.placeholder.com/300x200?text=Kit+Industrial+15000',
                specs: ['Potencia: 15000W', 'Bater√≠a: 1000Ah', 'Panel: 25x350W', 'Inversor: 15000W'],
                whatsappId: 'EKOV15000' 
            },
            
            // Bombas Superficiales
            { 
                id: 'bomba-sup-05hp', 
                name: 'Bomba Superficial 0.5HP', 
                category: 'bombas-superficiales', 
                price: 5500, 
                description: 'Ideal para peque√±os riegos y tanques elevados. Caudal hasta 2000 L/h.',
                image: 'https://via.placeholder.com/300x200?text=Bomba+Superficial+0.5HP',
                specs: ['Potencia: 0.5HP', 'Caudal m√°x: 2000 L/h', 'Altura m√°x: 20m', 'Voltaje: 12V/24V'],
                whatsappId: 'BSUP05' 
            },
            { 
                id: 'bomba-sup-1hp', 
                name: 'Bomba Superficial 1HP', 
                category: 'bombas-superficiales', 
                price: 8500, 
                description: 'Para pozos superficiales y uso dom√©stico. Caudal hasta 15000 L/h.',
                image: 'https://via.placeholder.com/300x200?text=Bomba+Superficial+1HP',
                specs: ['Potencia: 1HP', 'Caudal m√°x: 15000 L/h', 'Altura m√°x: 30m', 'Voltaje: 24V/48V'],
                whatsappId: 'BSUP1' 
            },
            { 
                id: 'bomba-sup-2hp', 
                name: 'Bomba Superficial 2HP', 
                category: 'bombas-superficiales', 
                price: 14500, 
                description: 'Alto caudal para riego agr√≠cola. Caudal hasta 30000 L/h.',
                image: 'https://via.placeholder.com/300x200?text=Bomba+Superficial+2HP',
                specs: ['Potencia: 2HP', 'Caudal m√°x: 30000 L/h', 'Altura m√°x: 40m', 'Voltaje: 48V'],
                whatsappId: 'BSUP2' 
            },
            { 
                id: 'bomba-sup-3hp', 
                name: 'Bomba Superficial 3HP', 
                category: 'bombas-superficiales', 
                price: 19500, 
                description: 'Para grandes caudales, hasta 50000 L/h. Ideal para sistemas de riego industrial.',
                image: 'https://via.placeholder.com/300x200?text=Bomba+Superficial+3HP',
                specs: ['Potencia: 3HP', 'Caudal m√°x: 50000 L/h', 'Altura m√°x: 50m', 'Voltaje: 48V/110V'],
                whatsappId: 'BSUP3' 
            },
            
            // Bombas Sumergibles
            { 
                id: 'bomba-sum-1hp', 
                name: 'Bomba Sumergible 1HP', 
                category: 'bombas-sumergibles', 
                price: 12500, 
                description: 'Para pozos profundos hasta 30m. Di√°metro m√≠nimo 3".',
                image: 'https://via.placeholder.com/300x200?text=Bomba+Sumergible+1HP',
                specs: ['Potencia: 1HP', 'Profundidad m√°x: 30m', 'Di√°metro: 3"', 'Salida: 1.25"', 'Voltaje: 24V/48V'],
                whatsappId: 'BSUM1' 
            },
            { 
                id: 'bomba-sum-2hp', 
                name: 'Bomba Sumergible 2HP', 
                category: 'bombas-sumergibles', 
                price: 19500, 
                description: 'Para pozos profundos hasta 50m. Di√°metro m√≠nimo 4".',
                image: 'https://via.placeholder.com/300x200?text=Bomba+Sumergible+2HP',
                specs: ['Potencia: 2HP', 'Profundidad m√°x: 50m', 'Di√°metro: 4"', 'Salida: 2"', 'Voltaje: 48V/110V'],
                whatsappId: 'BSUM2' 
            },
            { 
                id: 'bomba-sum-3hp', 
                name: 'Bomba Sumergible 3HP', 
                category: 'bombas-sumergibles', 
                price: 28500, 
                description: 'Alta presi√≥n para pozos profundos hasta 100m. Di√°metro m√≠nimo 6".',
                image: 'https://via.placeholder.com/300x200?text=Bomba+Sumergible+3HP',
                specs: ['Potencia: 3HP', 'Profundidad m√°x: 100m', 'Di√°metro: 6"', 'Salida: 3"', 'Voltaje: 110V/220V'],
                whatsappId: 'BSUM3' 
            },
            
            // Paneles
            { 
                id: 'panel-300w', 
                name: 'Panel Solar 300W', 
                category: 'paneles', 
                price: 4200, 
                description: 'Panel monocristalino de alta eficiencia. Ideal para sistemas de 12V/24V.',
                image: 'https://via.placeholder.com/300x200?text=Panel+300W',
                specs: ['Potencia: 300W', 'Eficiencia: 21%', 'Voc: 40V', 'Isc: 9A'],
                whatsappId: 'PAN300' 
            },
            { 
                id: 'panel-450w', 
                name: 'Panel Solar 450W', 
                category: 'paneles', 
                price: 6200, 
                description: 'Panel bifacial para mayor rendimiento. Capta luz por ambos lados.',
                image: 'https://via.placeholder.com/300x200?text=Panel+450W',
                specs: ['Potencia: 450W', 'Eficiencia: 22%', 'Voc: 50V', 'Isc: 11A'],
                whatsappId: 'PAN450' 
            }
        ];

        // ================== ESTADO GLOBAL ==================
        let trafficSource = { type: 'direct', partnerCode: null, partnerData: null, welcomeMessageSent: false };
        let selectedSector = '';
        let totalW = 0, totalKWh = 0;
        let artefactosSeleccionados = [];
        let recommendedKit = '', kitWhatsappId = '', kitDescription = '';
        let selectedProduct = null; // Para pago directo
        let carrito = [];

        // ================== INICIALIZACI√ìN ==================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Ekov Solar con im√°genes estables');
            detectTrafficSource();
            initNavigation();
            initStore();
            loadWhatsAppCatalog();
            loadTutorials();
            cargarCarrito();
            actualizarContadorCarrito();
        });

        // ================== DETECCI√ìN DE FUENTE ==================
        function detectTrafficSource() {
            const urlParams = new URLSearchParams(window.location.search);
            const partnerCode = urlParams.get('partner');
            if (partnerCode && PARTNERS_DATABASE[partnerCode]) {
                trafficSource = { type: 'partner', partnerCode, partnerData: PARTNERS_DATABASE[partnerCode], welcomeMessageSent: false };
                localStorage.setItem('ekov_partner_code', partnerCode);
                showLinkSaverCard();
            } else {
                trafficSource = { type: 'direct', partnerCode: null, partnerData: null, welcomeMessageSent: false };
            }
            updateSourceUI();
        }

        function showLinkSaverCard() {
            const card = document.getElementById('linkSaverCard');
            const linkField = document.getElementById('appLinkField');
            if (card && linkField) {
                linkField.value = `${APP_URL}?partner=${trafficSource.partnerCode}`;
                card.style.display = 'block';
            }
        }

        window.closeLinkSaver = () => document.getElementById('linkSaverCard').style.display = 'none';
        
        window.copyAppLink = () => {
            const linkField = document.getElementById('appLinkField');
            linkField.select();
            linkField.setSelectionRange(0, 99999);
            try {
                navigator.clipboard.writeText(linkField.value).then(() => {
                    alert('‚úÖ Enlace copiado al portapapeles');
                }).catch(() => {
                    document.execCommand('copy');
                    alert('‚úÖ Enlace copiado (m√©todo alternativo)');
                });
            } catch (err) {
                document.execCommand('copy');
                alert('‚úÖ Enlace copiado');
            }
        };

        window.sendLinkToSelf = () => {
            const link = document.getElementById('appLinkField').value;
            window.open(`https://wa.me/?text=${encodeURIComponent('Mi enlace de Ekov Solar: ' + link)}`, '_blank');
        };

        function updateSourceUI() {
            if (trafficSource.type === 'partner') {
                document.getElementById('partnerBadge').style.display = 'inline-block';
                document.getElementById('partnerBadge').textContent = `ü§ù ${trafficSource.partnerCode}`;
                document.getElementById('directBadge').style.display = 'none';
                
                document.getElementById('partnerInfo').style.display = 'block';
                document.getElementById('partnerName').textContent = trafficSource.partnerData.nombre;
                document.getElementById('partnerLocation').textContent = trafficSource.partnerData.ubicacion;
                
                document.getElementById('footerPartnerInfo').style.display = 'block';
                document.getElementById('footerPartnerName').textContent = trafficSource.partnerData.nombre;
                document.getElementById('footerPartnerLocation').textContent = trafficSource.partnerData.ubicacion;
                document.getElementById('footerDirectInfo').style.display = 'none';
            } else {
                document.getElementById('directBadge').style.display = 'inline-block';
                document.getElementById('partnerBadge').style.display = 'none';
                
                document.getElementById('directInfo').style.display = 'block';
                document.getElementById('partnerInfo').style.display = 'none';
                
                document.getElementById('footerDirectInfo').style.display = 'block';
                document.getElementById('footerPartnerInfo').style.display = 'none';
            }
        }

        // ================== CAT√ÅLOGO DE CONSUMO ==================
        const catalog = {
            hogar: [
                {n: 'Aire acondicionado habitaci√≥n', w: 1200, h: 8},
                {n: 'Nevera familiar', w: 250, h: 12},
                {n: 'Bombillos LED interiores', w: 10, h: 6},
                {n: 'Televisor 55"', w: 150, h: 5},
                {n: 'Computadora', w: 200, h: 6},
                {n: 'Ventilador techo', w: 75, h: 8}
            ],
            turismo: [
                {n: 'Habitaciones con A/A', w: 1200, h: 8},
                {n: 'Nevera bar', w: 300, h: 12},
                {n: 'Bombillos LED √°reas comunes', w: 20, h: 10},
                {n: 'Bomba agua cisterna', w: 750, h: 2},
                {n: 'Ascensor peque√±o', w: 1500, h: 4},
                {n: 'Calentador el√©ctrico', w: 1500, h: 3}
            ],
            comercio: [
                {n: 'A/A oficina', w: 2000, h: 8},
                {n: 'Nevera exhibidora', w: 400, h: 12},
                {n: 'Iluminaci√≥n LED', w: 200, h: 10},
                {n: 'Computadoras', w: 300, h: 8},
                {n: 'Impresora', w: 500, h: 4},
                {n: 'Sistema sonido', w: 200, h: 6}
            ],
            agro: [
                {n: 'Bomba riego', w: 1000, h: 4},
                {n: 'Cerca el√©ctrica', w: 50, h: 24},
                {n: 'Refrigerador', w: 600, h: 12},
                {n: 'Iluminaci√≥n exterior', w: 200, h: 10},
                {n: 'Orde√±o el√©ctrico', w: 750, h: 3},
                {n: 'Ventiladores granja', w: 300, h: 8}
            ],
            telecom: [
                {n: 'Radio enlace', w: 150, h: 24},
                {n: 'C√°maras IP', w: 30, h: 24},
                {n: 'Router/switch', w: 50, h: 24},
                {n: 'UPS', w: 500, h: 24},
                {n: 'Repetidor WiFi', w: 25, h: 24},
                {n: 'Monitoreo remoto', w: 100, h: 24}
            ]
        };

        // ================== NAVEGACI√ìN ==================
        function initNavigation() {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
        }
        
        function switchTab(tabId) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`${tabId}-tab`).classList.add('active');
            if (tabId === 'cart') renderCart();
        }

        // ================== INICIALIZAR SECTOR ==================
        function initApp(sector) {
            selectedSector = sector;
            let html = '';
            
            if (sector === 'bombas') {
                html = `
                    <div class="device-row">
                        <label>Tipo de bomba:</label>
                        <select id="bombaTipo" onchange="updateBombaFields()">
                            <option value="superficial">Superficial</option>
                            <option value="sumergible">Sumergible</option>
                        </select>
                    </div>
                    <div id="bombaCampos"></div>
                    <div class="device-row">
                        <label>Voltaje del sistema:</label>
                        <select id="bombaVoltaje">
                            <option value="12V">12V</option>
                            <option value="24V">24V</option>
                            <option value="48V">48V</option>
                            <option value="110V">110V AC</option>
                            <option value="220V">220V AC</option>
                        </select>
                    </div>
                    <div class="device-row">
                        <label>Potencia del motor (HP):</label>
                        <select id="bombaPotencia">
                            <option value="0.5">0.5 HP</option>
                            <option value="1">1 HP</option>
                            <option value="2">2 HP</option>
                            <option value="3">3 HP</option>
                            <option value="5">5 HP</option>
                        </select>
                    </div>
                `;
                document.getElementById('itemsContainer').innerHTML = html;
                updateBombaFields();
            } else {
                catalog[sector].forEach((item, i) => {
                    html += `<div class="device-row"><span>${item.n} <small>(${item.w}W)</small></span><input type="number" id="input-${i}" value="0" min="0" max="99"></div>`;
                });
                document.getElementById('itemsContainer').innerHTML = html;
            }
            showStep(2);
        }

        window.updateBombaFields = function() {
            const tipo = document.getElementById('bombaTipo').value;
            const contenedor = document.getElementById('bombaCampos');
            let html = '';
            if (tipo === 'superficial') {
                html = `
                    <div class="device-row">
                        <label>Caudal (litros/hora):</label>
                        <select id="bombaCaudal">
                            <option value="2000">2000 L/h</option>
                            <option value="5000">5000 L/h</option>
                            <option value="15000">15000 L/h</option>
                            <option value="30000">30000 L/h</option>
                            <option value="50000">50000 L/h</option>
                        </select>
                    </div>
                    <div class="device-row">
                        <label>Altura de elevaci√≥n (m):</label>
                        <select id="bombaAltura">
                            <option value="10">10 m</option>
                            <option value="20">20 m</option>
                            <option value="30">30 m</option>
                            <option value="40">40 m</option>
                            <option value="50">50 m</option>
                        </select>
                    </div>
                `;
            } else {
                html = `
                    <div class="device-row">
                        <label>Di√°metro del pozo (pulgadas):</label>
                        <select id="bombaDiametroPozo">
                            <option value="3">3"</option>
                            <option value="4">4"</option>
                            <option value="6">6"</option>
                            <option value="8">8"</option>
                        </select>
                    </div>
                    <div class="device-row">
                        <label>Profundidad (metros):</label>
                        <select id="bombaProfundidad">
                            <option value="20">20 m</option>
                            <option value="30">30 m</option>
                            <option value="50">50 m</option>
                            <option value="80">80 m</option>
                            <option value="100">100 m</option>
                            <option value="150">150 m</option>
                        </select>
                    </div>
                    <div class="device-row">
                        <label>Di√°metro de salida (pulgadas):</label>
                        <select id="bombaSalida">
                            <option value="1.25">1.25"</option>
                            <option value="2">2"</option>
                            <option value="3">3"</option>
                            <option value="4">4"</option>
                        </select>
                    </div>
                `;
            }
            contenedor.innerHTML = html;
        };

        // ================== C√ÅLCULO ==================
        function calculate() {
            if (selectedSector === 'bombas') {
                const tipo = document.getElementById('bombaTipo').value;
                const voltaje = document.getElementById('bombaVoltaje').value;
                const potenciaHP = parseFloat(document.getElementById('bombaPotencia').value);
                
                let recomendacion = '';
                let descripcion = '';
                let productId = '';
                
                if (tipo === 'superficial') {
                    const caudal = parseInt(document.getElementById('bombaCaudal').value);
                    const altura = parseInt(document.getElementById('bombaAltura').value);
                    
                    if (potenciaHP <= 0.5 && caudal <= 2000 && altura <= 20) {
                        recomendacion = 'Bomba Superficial 0.5HP';
                        productId = 'bomba-sup-05hp';
                        descripcion = `Ideal para ${caudal} L/h a ${altura}m. Voltaje ${voltaje}.`;
                    } else if (potenciaHP <= 1 && caudal <= 15000 && altura <= 30) {
                        recomendacion = 'Bomba Superficial 1HP';
                        productId = 'bomba-sup-1hp';
                        descripcion = `Adecuada para ${caudal} L/h a ${altura}m. Voltaje ${voltaje}.`;
                    } else if (potenciaHP <= 2 && caudal <= 30000 && altura <= 40) {
                        recomendacion = 'Bomba Superficial 2HP';
                        productId = 'bomba-sup-2hp';
                        descripcion = `Para ${caudal} L/h a ${altura}m. Voltaje ${voltaje}.`;
                    } else {
                        recomendacion = 'Bomba Superficial 3HP o mayor';
                        productId = 'bomba-sup-3hp';
                        descripcion = `Para ${caudal} L/h a ${altura}m. Consulte disponibilidad. Voltaje ${voltaje}.`;
                    }
                    kitWhatsappId = productId.toUpperCase().replace(/-/g, '');
                    
                } else {
                    const diametro = document.getElementById('bombaDiametroPozo').value;
                    const profundidad = parseInt(document.getElementById('bombaProfundidad').value);
                    const salida = document.getElementById('bombaSalida').value;
                    
                    if (potenciaHP <= 1 && profundidad <= 30 && diametro >= 3) {
                        recomendacion = 'Bomba Sumergible 1HP';
                        productId = 'bomba-sum-1hp';
                        descripcion = `Para pozo ${diametro}", profundidad ${profundidad}m, salida ${salida}". Voltaje ${voltaje}.`;
                    } else if (potenciaHP <= 2 && profundidad <= 50 && diametro >= 4) {
                        recomendacion = 'Bomba Sumergible 2HP';
                        productId = 'bomba-sum-2hp';
                        descripcion = `Para pozo ${diametro}", profundidad ${profundidad}m, salida ${salida}". Voltaje ${voltaje}.`;
                    } else if (potenciaHP <= 3 && profundidad <= 100 && diametro >= 6) {
                        recomendacion = 'Bomba Sumergible 3HP';
                        productId = 'bomba-sum-3hp';
                        descripcion = `Para pozo ${diametro}", profundidad ${profundidad}m, salida ${salida}". Voltaje ${voltaje}.`;
                    } else {
                        recomendacion = 'Bomba Sumergible de alta potencia';
                        productId = 'bomba-sum-3hp';
                        descripcion = `Para pozo ${diametro}", profundidad ${profundidad}m, salida ${salida}". Consulte disponibilidad. Voltaje ${voltaje}.`;
                    }
                    kitWhatsappId = productId.toUpperCase().replace(/-/g, '');
                }
                
                document.getElementById('cons-info').innerHTML = ``;
                document.getElementById('kit-name').innerText = recomendacion;
                document.getElementById('kit-desc').innerText = descripcion;
                
                const producto = storeProducts.find(p => p.id === productId);
                if (producto) {
                    document.getElementById('storeLinkContainer').innerHTML = `
                        <a href="#" onclick="switchTab('store');" class="store-link">üîç Ver este producto en la tienda</a>
                    `;
                } else {
                    document.getElementById('storeLinkContainer').innerHTML = '';
                }
                
                artefactosSeleccionados = [{ nombre: 'Consulta de bomba', cantidad: 1 }];
                
            } else {
                totalW = 0; totalKWh = 0; artefactosSeleccionados = [];
                catalog[selectedSector].forEach((item, i) => {
                    const qty = parseInt(document.getElementById(`input-${i}`).value) || 0;
                    if(qty > 0) {
                        totalW += qty * item.w;
                        totalKWh += (qty * item.w * item.h) / 1000;
                        artefactosSeleccionados.push({nombre: item.n, cantidad: qty});
                    }
                });
                if (totalW === 0) { alert("Ingrese cantidades"); return; }
                
                let productId = '';
                if (totalW <= 1000) { 
                    recommendedKit = "EKOV RESCUE 1000"; 
                    kitWhatsappId = "EKOV1000"; 
                    kitDescription = "Ideal para iluminaci√≥n y dispositivos esenciales.";
                    productId = 'ekov1000';
                } else if (totalW <= 3000) { 
                    recommendedKit = "EKOV COMFORT 3000"; 
                    kitWhatsappId = "EKOV3000"; 
                    kitDescription = "Perfecto para hogares, incluye nevera y TV.";
                    productId = 'ekov3000';
                } else if (totalW <= 5000) { 
                    recommendedKit = "EKOV INDEPENDENCE 5000"; 
                    kitWhatsappId = "EKOV5000"; 
                    kitDescription = "Peque√±as empresas y oficinas.";
                    productId = 'ekov5000';
                } else if (totalW <= 12000) { 
                    recommendedKit = "EKOV INDUSTRIAL 12000"; 
                    kitWhatsappId = "EKOV12000"; 
                    kitDescription = "Industrial para grandes consumos.";
                    productId = 'ekov12000';
                } else { 
                    recommendedKit = "EKOV INDUSTRIAL 15000"; 
                    kitWhatsappId = "EKOV15000"; 
                    kitDescription = "Alta potencia para proyectos grandes.";
                    productId = 'ekov15000';
                }
                
                document.getElementById('cons-info').innerHTML = ``;
                document.getElementById('kit-name').innerText = recommendedKit;
                document.getElementById('kit-desc').innerText = kitDescription;
                
                const producto = storeProducts.find(p => p.id === productId);
                if (producto) {
                    document.getElementById('storeLinkContainer').innerHTML = `
                        <a href="#" onclick="switchTab('store');" class="store-link">üîç Ver este producto en la tienda</a>
                    `;
                } else {
                    document.getElementById('storeLinkContainer').innerHTML = '';
                }
            }
            
            showStep(3);
        }
        
        function showStep(stepNum) {
            document.querySelectorAll('.step').forEach(d => d.classList.remove('active'));
            document.getElementById(`step${stepNum}`).classList.add('active');
            window.scrollTo(0,0);
        }
        
        function resetCalculator() { 
            selectedSector = ''; 
            totalW = 0; totalKWh = 0; 
            artefactosSeleccionados = []; 
            showStep(1); 
        }

        // ================== WHATSAPP CONSULTA (usa n√∫mero de consultas) ==================
        function sendWA() {
            const now = new Date();
            const fecha = now.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const hora = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', hour12: true });
            
            let msg = `üîã *NUEVA CONSULTA*\n\nüìÖ ${fecha} ‚è∞ ${hora}\n\n`;
            
            if (trafficSource.type === 'partner') {
                msg += `üè™ *Aliado:* ${trafficSource.partnerData.nombre} (${trafficSource.partnerCode})\nüìç ${trafficSource.partnerData.ubicacion}\n\n`;
            } else {
                msg += `üì± *Fuente:* Visita Directa\n\n`;
            }
            
            if (selectedSector === 'bombas') {
                const tipo = document.getElementById('bombaTipo').value;
                const voltaje = document.getElementById('bombaVoltaje').value;
                const potencia = document.getElementById('bombaPotencia').value;
                msg += `üö∞ *Tipo:* ${tipo === 'superficial' ? 'Superficial' : 'Sumergible'}\n`;
                msg += `‚ö° *Voltaje:* ${voltaje}\n`;
                msg += `üêé *Potencia:* ${potencia} HP\n`;
                if (tipo === 'superficial') {
                    const caudal = document.getElementById('bombaCaudal').value;
                    const altura = document.getElementById('bombaAltura').value;
                    msg += `üíß *Caudal:* ${caudal} L/h\n`;
                    msg += `üìè *Altura:* ${altura} m\n`;
                } else {
                    const diametro = document.getElementById('bombaDiametroPozo').value;
                    const profundidad = document.getElementById('bombaProfundidad').value;
                    const salida = document.getElementById('bombaSalida').value;
                    msg += `üìè *Di√°metro pozo:* ${diametro}"\n`;
                    msg += `üìê *Profundidad:* ${profundidad} m\n`;
                    msg += `üîß *Salida:* ${salida}"\n`;
                }
                msg += `\n‚ö° *Equipo recomendado:* ${document.getElementById('kit-name').innerText}\n`;
                msg += `üìù *Detalle:* ${document.getElementById('kit-desc').innerText}\n`;
                msg += `üÜî *C√≥digo:* ${kitWhatsappId}\n`;
                msg += `üîó *Cat√°logo:* https://wa.me/c/${CATALOG_WHATSAPP_NUMBER}/${kitWhatsappId}`;
            } else {
                const sectorNames = { 'hogar': 'Hogar', 'turismo': 'Hoteles', 'comercio': 'Comercio', 'agro': 'Agro', 'telecom': 'Telecom' };
                let dispositivos = '';
                artefactosSeleccionados.forEach(i => dispositivos += `‚Ä¢ ${i.nombre}: ${i.cantidad}\n`);
                const catalogoLink = `https://wa.me/c/${CATALOG_WHATSAPP_NUMBER}/${kitWhatsappId}`;
                msg += `üè¢ *Sector:* ${sectorNames[selectedSector]}\n‚ö° *Equipo:* ${recommendedKit}\nüìä *Consumo:* ${totalKWh.toFixed(1)} kWh/d√≠a\nüÜî *C√≥digo:* ${kitWhatsappId}\nüîó *Cat√°logo:* ${catalogoLink}\n\nüìã *Dispositivos:*\n${dispositivos}\nüì± *Enlace:* ${catalogoLink}`;
            }
            
            window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`, '_blank');
        }

        // ================== TIENDA (con im√°genes dimensionadas y placeholder local) ==================
        function initStore() {
            renderStoreProducts(storeProducts);
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    filterStoreProducts(this.dataset.category);
                });
            });
        }
        
        function renderStoreProducts(products) {
            const grid = document.getElementById('productGrid');
            const loading = document.getElementById('loadingState');
            if (loading) loading.style.display = 'none';
            grid.innerHTML = '';
            products.forEach(p => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.id = `product-${p.id}`;
                card.innerHTML = `
                    <div class="product-image">
                        <img src="${p.image}" 
                             alt="${p.name}" 
                             width="300" 
                             height="200"
                             loading="lazy" 
                             onerror="this.src='${PLACEHOLDER_SVG}'">
                    </div>
                    <div class="product-info">
                        <h3 class="product-title">${p.name}</h3>
                        <div class="product-description">${p.description}</div>
                        <div class="product-price">$${p.price.toLocaleString()}</div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="whatsapp-button" onclick="consultarProducto('${p.name}', '${p.whatsappId}', ${p.price}, ${JSON.stringify(p.specs)})" style="flex: 1;">üí¨ Consultar</button>
                            <button class="btn-outline" onclick="agregarAlCarrito('${p.id}')" style="flex: 1;">‚ûï A√±adir</button>
                            <button class="btn-main" onclick="openPaymentModal('${p.name}', ${p.price})" style="flex: 1;">üõí Comprar</button>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }
        
        function filterStoreProducts(category) {
            if (category === 'all') renderStoreProducts(storeProducts);
            else renderStoreProducts(storeProducts.filter(p => p.category === category));
        }

        // ================== CONSULTAR PRODUCTO (WhatsApp) ==================
        function consultarProducto(name, id, price, specs) {
            let msg = `üõí *CONSULTA DE PRODUCTO*\n\n`;
            if (trafficSource.type === 'partner') {
                msg += `üè™ *Aliado:* ${trafficSource.partnerData.nombre} (${trafficSource.partnerCode})\nüìç ${trafficSource.partnerData.ubicacion}\n\n`;
            } else {
                msg += `üì± *Fuente:* Visita Directa\n\n`;
            }
            msg += `üè∑Ô∏è *Producto:* ${name}\nüí∞ *Precio:* $${price.toLocaleString()}\nüÜî *C√≥digo:* ${id}\n`;
            if (specs && specs.length) {
                msg += `üìã *Especificaciones:*\n`;
                specs.forEach(s => msg += `   ‚Ä¢ ${s}\n`);
            }
            msg += `\nüîó Ver en cat√°logo: https://wa.me/c/${CATALOG_WHATSAPP_NUMBER}/${id}`;
            window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`, '_blank');
        }

        // ================== CARRITO ==================
        function agregarAlCarrito(productId) {
            const producto = storeProducts.find(p => p.id === productId);
            if (!producto) return;
            
            const existente = carrito.find(item => item.id === productId);
            if (existente) {
                existente.cantidad += 1;
            } else {
                carrito.push({
                    id: producto.id,
                    nombre: producto.name,
                    precio: producto.price,
                    cantidad: 1,
                    imagen: producto.image
                });
            }
            guardarCarrito();
            actualizarContadorCarrito();
            alert('‚úÖ Producto a√±adido al carrito');
        }

        function guardarCarrito() {
            localStorage.setItem('ekov_carrito', JSON.stringify(carrito));
        }

        function cargarCarrito() {
            const guardado = localStorage.getItem('ekov_carrito');
            if (guardado) {
                try {
                    carrito = JSON.parse(guardado);
                } catch (e) {
                    carrito = [];
                }
            } else {
                carrito = [];
            }
            actualizarContadorCarrito();
        }

        function actualizarContadorCarrito() {
            const totalItems = carrito.reduce((acc, item) => acc + item.cantidad, 0);
            document.getElementById('cartCount').textContent = totalItems;
        }

        function renderCart() {
            const contenedor = document.getElementById('cartItems');
            const emptyDiv = document.getElementById('cartEmpty');
            const footerDiv = document.getElementById('cartFooter');
            
            if (carrito.length === 0) {
                contenedor.innerHTML = '';
                emptyDiv.style.display = 'block';
                footerDiv.style.display = 'none';
                return;
            }
            
            emptyDiv.style.display = 'none';
            footerDiv.style.display = 'block';
            
            let html = '';
            let total = 0;
            carrito.forEach(item => {
                total += item.precio * item.cantidad;
                html += `
                    <div class="cart-item">
                        <img src="${item.imagen}" alt="${item.nombre}" class="cart-item-image" loading="lazy" width="60" height="60" onerror="this.src='${PLACEHOLDER_SVG}'">
                        <div class="cart-item-details">
                            <div class="cart-item-title">${item.nombre}</div>
                            <div class="cart-item-price">$${item.precio.toLocaleString()}</div>
                            <div class="cart-item-quantity">
                                <button onclick="cambiarCantidad('${item.id}', -1)">‚àí</button>
                                <span>${item.cantidad}</span>
                                <button onclick="cambiarCantidad('${item.id}', 1)">+</button>
                                <button onclick="eliminarDelCarrito('${item.id}')" style="margin-left:10px;">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            contenedor.innerHTML = html;
            document.getElementById('cartTotal').innerHTML = `Total: $${total.toLocaleString()}`;
        }

        window.cambiarCantidad = function(productId, delta) {
            const item = carrito.find(i => i.id === productId);
            if (!item) return;
            item.cantidad += delta;
            if (item.cantidad <= 0) {
                carrito = carrito.filter(i => i.id !== productId);
            }
            guardarCarrito();
            actualizarContadorCarrito();
            renderCart();
        };

        window.eliminarDelCarrito = function(productId) {
            carrito = carrito.filter(i => i.id !== productId);
            guardarCarrito();
            actualizarContadorCarrito();
            renderCart();
        };

        window.clearCart = function() {
            carrito = [];
            guardarCarrito();
            actualizarContadorCarrito();
            renderCart();
        };

        function checkoutCart() {
            if (carrito.length === 0) {
                alert('El carrito est√° vac√≠o');
                return;
            }
            const total = carrito.reduce((acc, item) => acc + item.precio * item.cantidad, 0);
            selectedProduct = { name: "Carrito de compras", price: total };
            openPaymentModal("Carrito de compras", total);
        }

        // ================== MODAL DE PAGO ==================
        let metodoPagoSeleccionado = 'transferencia';

        function openPaymentModal(productName, productPrice) {
            selectedProduct = { name: productName, price: productPrice };
            document.getElementById('paymentModal').style.display = 'flex';
            document.getElementById('step1-payment').style.display = 'block';
            document.getElementById('step2-payment').style.display = 'none';
            document.getElementById('modalCloseBtn').style.display = 'block';
            document.getElementById('paymentReference').value = '';
            document.getElementById('paymentAmount').value = '';
            document.getElementById('paymentName').value = '';
            document.getElementById('confirmDelivery').checked = true;
            mostrarDatosPago();
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').style.display = 'none';
            selectedProduct = null;
        }

        window.mostrarDatosPago = function() {
            const radios = document.getElementsByName('metodoPago');
            for (let radio of radios) {
                if (radio.checked) {
                    metodoPagoSeleccionado = radio.value;
                    break;
                }
            }
            document.getElementById('datosTransferencia').style.display = 'none';
            document.getElementById('datosPagoMovil').style.display = 'none';
            document.getElementById('datosBinance').style.display = 'none';
            document.getElementById('datosZelle').style.display = 'none';
            
            if (metodoPagoSeleccionado === 'transferencia') {
                document.getElementById('datosTransferencia').style.display = 'block';
            } else if (metodoPagoSeleccionado === 'pagoMovil') {
                document.getElementById('datosPagoMovil').style.display = 'block';
            } else if (metodoPagoSeleccionado === 'binance') {
                document.getElementById('datosBinance').style.display = 'block';
            } else if (metodoPagoSeleccionado === 'zelle') {
                document.getElementById('datosZelle').style.display = 'block';
            }
        };

        window.mostrarConfirmacionPago = function() {
            let metodoTexto = '';
            if (metodoPagoSeleccionado === 'transferencia') metodoTexto = 'Transferencia bancaria';
            else if (metodoPagoSeleccionado === 'pagoMovil') metodoTexto = 'Pago m√≥vil';
            else if (metodoPagoSeleccionado === 'binance') metodoTexto = 'Binance (Cripto)';
            else if (metodoPagoSeleccionado === 'zelle') metodoTexto = 'Zelle';
            document.getElementById('metodoElegido').textContent = metodoTexto;
            document.getElementById('step1-payment').style.display = 'none';
            document.getElementById('step2-payment').style.display = 'block';
            document.getElementById('modalCloseBtn').style.display = 'none';
        };

        window.volverPaso1 = function() {
            document.getElementById('step1-payment').style.display = 'block';
            document.getElementById('step2-payment').style.display = 'none';
            document.getElementById('modalCloseBtn').style.display = 'block';
        };

        function sendPaymentConfirmation() {
            const reference = document.getElementById('paymentReference').value.trim();
            const amount = document.getElementById('paymentAmount').value.trim();
            const name = document.getElementById('paymentName').value.trim();
            const deliveryAccepted = document.getElementById('confirmDelivery').checked;
            
            if (!reference || !amount) {
                alert('Por favor, completa la referencia y el monto.');
                return;
            }
            
            let product = selectedProduct ? selectedProduct.name : 'Producto no especificado';
            let detalleProductos = '';
            
            if (product === "Carrito de compras" && carrito.length > 0) {
                detalleProductos = '\nüì¶ *Productos en carrito:*\n';
                carrito.forEach(item => {
                    detalleProductos += `   ‚Ä¢ ${item.nombre} x${item.cantidad} = $${(item.precio * item.cantidad).toLocaleString()}\n`;
                });
            }
            
            const now = new Date();
            const fecha = now.toLocaleDateString('es-ES');
            const hora = now.toLocaleTimeString('es-ES');
            
            let metodo = '';
            if (metodoPagoSeleccionado === 'transferencia') metodo = 'Transferencia bancaria';
            else if (metodoPagoSeleccionado === 'pagoMovil') metodo = 'Pago m√≥vil';
            else if (metodoPagoSeleccionado === 'binance') metodo = 'Binance (Cripto)';
            else if (metodoPagoSeleccionado === 'zelle') metodo = 'Zelle';
            
            let message = `‚úÖ *CONFIRMACI√ìN DE PAGO*\n\n`;
            message += `üìÖ Fecha: ${fecha} ‚è∞ Hora: ${hora}\n\n`;
            message += `üõí *Producto:* ${product}\n`;
            message += detalleProductos;
            message += `üí≥ *M√©todo de pago:* ${metodo}\n`;
            message += `üí∞ *Monto:* $${amount}\n`;
            message += `üìÑ *Referencia:* ${reference}\n`;
            if (name) message += `üë§ *Cliente:* ${name}\n`;
            message += `‚è±Ô∏è *Tiempo de entrega aceptado:* 3-5 d√≠as h√°biles\n`;
            if (trafficSource.type === 'partner') {
                message += `\nüè™ *Aliado:* ${trafficSource.partnerData.nombre} (${trafficSource.partnerCode})\n`;
                message += `üìç ${trafficSource.partnerData.ubicacion}\n`;
            }
            message += `\n_Esperando verificaci√≥n._`;
            
            window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`, '_blank');
            
            closePaymentModal();
            alert('‚úÖ Confirmaci√≥n enviada. Te contactaremos para verificar el pago.');
        }

        // ================== CAT√ÅLOGO WHATSAPP ==================
        function loadWhatsAppCatalog() {
            setTimeout(() => {
                const cat = document.getElementById('whatsappCatalog');
                if (!cat) return;
                const catalogProducts = [
                    { name: 'Inversor H√≠brido 5000W', code: 'INV5000', category: 'inversores', price: 'Consultar', image: 'https://via.placeholder.com/300x200?text=Inversor+5000W', desc: 'Inversor solar h√≠brido con cargador MPPT.' },
                    { name: 'Bater√≠a Litio 5kWh', code: 'BATLIT5', category: 'baterias', price: 'Consultar', image: 'https://via.placeholder.com/300x200?text=Bateria+Litio+5kWh', desc: 'Bater√≠a de litio de ciclo profundo.' },
                    { name: 'Controlador MPPT 100A', code: 'MPPT100', category: 'controladores', price: 'Consultar', image: 'https://via.placeholder.com/300x200?text=Controlador+MPPT', desc: 'Controlador de carga solar MPPT 100A.' }
                ];
                let html = '<div style="display:grid; gap:15px;">';
                catalogProducts.forEach(p => {
                    html += `
                        <div style="background:white; padding:15px; border-radius:10px; border:1px solid #ddd;">
                            <div class="catalog-image">
                                <img src="${p.image}" alt="${p.name}" loading="lazy" width="300" height="150" onerror="this.src='${PLACEHOLDER_SVG}'">
                            </div>
                            <div><strong>${p.name}</strong><br><small>${p.category}</small></div>
                            <div style="margin:10px 0; color:var(--gray); font-size:0.9rem;">${p.desc}</div>
                            <div><span style="color:var(--primary); font-weight:bold;">${p.price}</span></div>
                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <button onclick="window.open('https://wa.me/c/${CATALOG_WHATSAPP_NUMBER}/${p.code}', '_blank')" class="btn-outline" style="flex:1;">üì¶ Ver en cat√°logo</button>
                                <button onclick="consultarProductoCatalogo('${p.name}', '${p.code}')" class="whatsapp-button" style="flex:1;">üí¨ Consultar</button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                cat.innerHTML = html;
            }, 1000);
        }

        // Funci√≥n para consultar un producto del cat√°logo
        function consultarProductoCatalogo(name, code) {
            let msg = `Hola, vi el producto ${name} (${code}) en su cat√°logo y me gustar√≠a m√°s informaci√≥n.`;
            if (trafficSource.type === 'partner') {
                msg += `\n\nVengo del aliado ${trafficSource.partnerData.nombre} (${trafficSource.partnerCode}).`;
            }
            window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`, '_blank');
        }

        // ================== TUTORIALES ==================
        function loadTutorials() {
            const tutorials = [
                { id: 'bienvenida', title: 'Video de bienvenida', desc: 'Conoce Ekov Solar y c√≥mo podemos ayudarte a ahorrar energ√≠a.' },
                { id: 'calculadora', title: 'C√≥mo usar la calculadora', desc: 'Aprende a dimensionar tu sistema solar paso a paso.' },
                { id: 'tienda', title: 'Gu√≠a de la tienda', desc: 'Descubre c√≥mo comprar productos y a√±adirlos al carrito.' },
                { id: 'catalogo', title: 'Cat√°logo WhatsApp', desc: 'Consulta productos disponibles directamente por WhatsApp.' },
                { id: 'asesoria', title: 'Asesor√≠a y proyectos', desc: 'Conoce nuestros servicios de asesor√≠a t√©cnica personalizada.' },
                { id: 'pago', title: 'Proceso de compra y pago', desc: 'Aprende a finalizar tu compra y elegir el m√©todo de pago.' }
            ];
            const container = document.getElementById('tutorialGrid');
            if (!container) return;
            let html = '';
            tutorials.forEach(t => {
                html += `
                    <div class="tutorial-card">
                        <div class="tutorial-thumbnail">
                            <img src="https://img.youtube.com/vi/placeholder_${t.id}/maxresdefault.jpg" alt="${t.title}" loading="lazy" width="300" height="169" onerror="this.src='${PLACEHOLDER_SVG}'">
                        </div>
                        <div class="tutorial-info">
                            <h4>${t.title}</h4>
                            <p>${t.desc}</p>
                            <a href="https://youtu.be/placeholder_${t.id}" target="_blank" class="tutorial-link">Ver video <i class="fas fa-external-link-alt"></i></a>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // Exponer funciones globales
        window.initApp = initApp;
        window.calculate = calculate;
        window.showStep = showStep;
        window.resetCalculator = resetCalculator;
        window.sendWA = sendWA;
        window.switchTab = switchTab;
        window.consultarProducto = consultarProducto;
        window.consultarProductoCatalogo = consultarProductoCatalogo;
        window.openPaymentModal = openPaymentModal;
        window.closePaymentModal = closePaymentModal;
        window.agregarAlCarrito = agregarAlCarrito;
        window.checkoutCart = checkoutCart;
        window.clearCart = clearCart;
        window.cambiarCantidad = cambiarCantidad;
        window.eliminarDelCarrito = eliminarDelCarrito;
        window.mostrarDatosPago = mostrarDatosPago;
        window.mostrarConfirmacionPago = mostrarConfirmacionPago;
        window.volverPaso1 = volverPaso1;
    </script>

    <!-- ================== REGISTRO SERVICE WORKER (OFFLINE) ================== -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('SW registrado:', reg))
                    .catch(err => console.log('Error al registrar SW:', err));
            });
        }
    </script>
</body>
</html>
